name: ğŸ”¨ Build Debug APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Environment setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: ğŸ“¦ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Initialize React Native Android project
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Initialize React Native project
        env:
          CI: true
        run: |
          echo "ğŸ”§ Creating React Native Android scaffold..."
          npx --yes react-native@0.73.6 init NFCMasterPro \
            --skip-install \
            --directory /tmp/nfc-build \
            --version 0.73.6
          echo "âœ… Scaffold created at /tmp/nfc-build"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Upgrade Android Gradle Plugin + compileSdk
      #    (RN 0.73.6 scaffold uses AGP 8.1.1 / compileSdk 34,
      #     but newer androidx libs require AGP 8.6.0 / compileSdk 35)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§ Patch Android Gradle configs
        run: |
          # Fix compileSdkVersion + targetSdkVersion to 35
          sed -i 's/compileSdkVersion = 34/compileSdkVersion = 35/' /tmp/nfc-build/android/build.gradle
          sed -i 's/targetSdkVersion = 34/targetSdkVersion = 35/' /tmp/nfc-build/android/build.gradle

          # Force androidx.core to version compatible with AGP 8.1.1
          # (androidx.core 1.16.0 requires AGP 8.6.0, but RN 0.73 uses AGP 8.1.1)
          echo "" >> /tmp/nfc-build/android/app/build.gradle
          echo "configurations.all { resolutionStrategy { force 'androidx.core:core:1.13.1'; force 'androidx.core:core-ktx:1.13.1' } }" >> /tmp/nfc-build/android/app/build.gradle

          echo "Gradle patches applied (compileSdk=35, androidx.core pinned to 1.13.1)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Overlay our custom source code
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“‹ Overlay custom source files
        run: |
          echo "ğŸ“‚ Copying custom source files..."
          cp -rf src/ /tmp/nfc-build/src/
          cp App.tsx /tmp/nfc-build/App.tsx
          cp metro.config.js /tmp/nfc-build/metro.config.js
          cp -rf shims/ /tmp/nfc-build/shims/

          echo "ğŸ“ Merging package.json dependencies..."
          node -e "
            const base = require('/tmp/nfc-build/package.json');
            const custom = require('${{ github.workspace }}/package.json');
            base.name = custom.name || base.name;
            base.version = custom.version || '1.0.0';
            base.dependencies = { ...base.dependencies, ...custom.dependencies };
            base.devDependencies = { ...base.devDependencies, ...custom.devDependencies };
            require('fs').writeFileSync('/tmp/nfc-build/package.json', JSON.stringify(base, null, 2));
            console.log('âœ… package.json merged');
          "

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Install dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“² Install npm dependencies
        working-directory: /tmp/nfc-build
        run: |
          npm install --legacy-peer-deps
          # Remove axios Node.js variant entirely â€” Metro must use browser build
          rm -rf node_modules/axios/dist/node/
          node -e "const p=require('./node_modules/axios/package.json'); delete p.exports; require('fs').writeFileSync('./node_modules/axios/package.json', JSON.stringify(p,null,2)); console.log('âœ… Axios patched for React Native');"
          echo "âœ… Dependencies installed"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Build Debug APK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”¨ Build Debug APK
        working-directory: /tmp/nfc-build/android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug \
            --no-daemon \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"
          echo "âœ… Debug APK built"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Upload artifact
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¤ Upload Debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: NFCMasterPro-debug-${{ github.sha }}
          path: /tmp/nfc-build/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
          if-no-files-found: error

      - name: ğŸ“Š APK Info
        if: success()
        run: |
          APK_PATH="/tmp/nfc-build/android/app/build/outputs/apk/debug/app-debug.apk"
          APK_SIZE=$(du -sh "$APK_PATH" | cut -f1)
          echo "âœ… Build successful!"
          echo "ğŸ“¦ APK size: $APK_SIZE"
          echo "ğŸ“ SHA: ${{ github.sha }}"
          echo "ğŸ”— Download from: Actions â†’ This run â†’ Artifacts"
