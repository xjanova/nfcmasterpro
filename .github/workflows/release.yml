name: ğŸš€ Auto Release APK

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as pre-release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    name: Build & Publish Release APK
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Determine version
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ·ï¸ Resolve version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          # Strip leading 'v' for numeric comparisons
          VERSION_NUM="${VERSION#v}"
          echo "TAG=$VERSION" >> $GITHUB_OUTPUT
          echo "NUM=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Building release: $VERSION"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Checkout
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Environment setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: ğŸ“¦ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Initialize React Native scaffold
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Initialize React Native project
        env:
          CI: true
        run: |
          echo "ğŸ”§ Creating React Native Android scaffold..."
          npx --yes react-native@0.73.6 init NFCMasterPro \
            --skip-install \
            --directory /tmp/nfc-release \
            --version 0.73.6
          echo "âœ… Scaffold ready"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Upgrade Android Gradle Plugin + compileSdk
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§ Patch Android Gradle configs
        run: |
          sed -i 's/compileSdkVersion = 34/compileSdkVersion = 35/' /tmp/nfc-release/android/build.gradle
          sed -i 's/targetSdkVersion = 34/targetSdkVersion = 35/' /tmp/nfc-release/android/build.gradle
          echo "" >> /tmp/nfc-release/android/app/build.gradle
          echo "configurations.all { resolutionStrategy { force 'androidx.core:core:1.13.1'; force 'androidx.core:core-ktx:1.13.1' } }" >> /tmp/nfc-release/android/app/build.gradle
          echo "Gradle patches applied"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Overlay source & update version
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“‹ Overlay source & set version
        run: |
          cp -rf src/ /tmp/nfc-release/src/
          cp App.tsx /tmp/nfc-release/App.tsx
          cp metro.config.js /tmp/nfc-release/metro.config.js
          cp -rf shims/ /tmp/nfc-release/shims/

          node -e "
            const fs = require('fs');
            const base = require('/tmp/nfc-release/package.json');
            const custom = require('${{ github.workspace }}/package.json');
            base.name = custom.name || base.name;
            base.version = '${{ steps.version.outputs.NUM }}';
            base.dependencies = { ...base.dependencies, ...custom.dependencies };
            base.devDependencies = { ...base.devDependencies, ...custom.devDependencies };
            fs.writeFileSync('/tmp/nfc-release/package.json', JSON.stringify(base, null, 2));
            console.log('âœ… package.json merged â€” version ${{ steps.version.outputs.NUM }}');
          "

          # Update versionName in build.gradle
          sed -i "s/versionName \"1.0\"/versionName \"${{ steps.version.outputs.NUM }}\"/" \
            /tmp/nfc-release/android/app/build.gradle || true

          echo "âœ… Version set to ${{ steps.version.outputs.NUM }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Install dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“² Install npm dependencies
        working-directory: /tmp/nfc-release
        run: npm install --legacy-peer-deps

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Generate release keystore
      #    (Use GitHub Secrets in production â€”
      #     see README for setup instructions)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”‘ Setup release signing keystore
        working-directory: /tmp/nfc-release/android
        run: |
          # Use GitHub Secret keystore if provided
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "ğŸ” Using keystore from GitHub Secrets"
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
            echo "MYAPP_RELEASE_STORE_FILE=release.keystore"        >> gradle.properties
            echo "MYAPP_RELEASE_KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> gradle.properties
            echo "MYAPP_RELEASE_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> gradle.properties
            echo "MYAPP_RELEASE_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}"        >> gradle.properties
          else
            echo "âš ï¸  No secret keystore found â€” auto-generating test keystore"
            keytool -genkey -v \
              -keystore app/release.keystore \
              -alias nfcmasterpro \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass nfcmaster2024 -keypass nfcmaster2024 \
              -dname "CN=NFCMasterPro,OU=App,O=xjanova,L=Bangkok,S=Bangkok,C=TH" \
              -noprompt
            echo "MYAPP_RELEASE_STORE_FILE=release.keystore" >> gradle.properties
            echo "MYAPP_RELEASE_KEY_ALIAS=nfcmasterpro"      >> gradle.properties
            echo "MYAPP_RELEASE_STORE_PASSWORD=nfcmaster2024" >> gradle.properties
            echo "MYAPP_RELEASE_KEY_PASSWORD=nfcmaster2024"   >> gradle.properties
          fi
          echo "âœ… Keystore ready"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Patch build.gradle to use release signing
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§ Configure release signing in build.gradle
        working-directory: /tmp/nfc-release/android
        run: |
          python3 - << 'EOF'
          import re, sys

          path = 'app/build.gradle'
          with open(path, 'r') as f:
              content = f.read()

          # Insert signingConfigs block before 'buildTypes {'
          signing_block = """    signingConfigs {
              release {
                  storeFile file(MYAPP_RELEASE_STORE_FILE)
                  storePassword MYAPP_RELEASE_STORE_PASSWORD
                  keyAlias MYAPP_RELEASE_KEY_ALIAS
                  keyPassword MYAPP_RELEASE_KEY_PASSWORD
              }
          }
          """

          if 'signingConfigs' not in content:
              # No signingConfigs at all â€” insert a new block
              content = content.replace('    buildTypes {', signing_block + '    buildTypes {')
          elif 'MYAPP_RELEASE_STORE_FILE' not in content:
              # signingConfigs exists (debug only) â€” inject release config inside it
              release_entry = (
                  "    signingConfigs {\n"
                  "        release {\n"
                  "            storeFile file(MYAPP_RELEASE_STORE_FILE)\n"
                  "            storePassword MYAPP_RELEASE_STORE_PASSWORD\n"
                  "            keyAlias MYAPP_RELEASE_KEY_ALIAS\n"
                  "            keyPassword MYAPP_RELEASE_KEY_PASSWORD\n"
                  "        }\n"
              )
              content = re.sub(r'signingConfigs\s*\{', release_entry + '        ', content, count=1)

          # Point release buildType to our signingConfig
          content = re.sub(
              r'(release\s*\{[^}]*?)signingConfig signingConfigs\.debug',
              r'\1signingConfig signingConfigs.release',
              content, flags=re.DOTALL
          )

          with open(path, 'w') as f:
              f.write(content)

          print("âœ… build.gradle patched for release signing")
          EOF

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Build Release APK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Build Release APK
        working-directory: /tmp/nfc-release/android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"
          echo "âœ… Release APK built"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 10. Rename APK with version
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Rename APK
        run: |
          mkdir -p /tmp/release-output
          cp /tmp/nfc-release/android/app/build/outputs/apk/release/app-release.apk \
             /tmp/release-output/NFCMasterPro-${{ steps.version.outputs.TAG }}.apk
          APK_SIZE=$(du -sh /tmp/release-output/NFCMasterPro-${{ steps.version.outputs.TAG }}.apk | cut -f1)
          echo "ğŸ“¦ APK: NFCMasterPro-${{ steps.version.outputs.TAG }}.apk ($APK_SIZE)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 11. Generate changelog from git log
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Generate release notes
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty="- %s (%h)" "$PREV_TAG"..HEAD 2>/dev/null | head -20)
          else
            CHANGES=$(git log --pretty="- %s (%h)" --max-count=10 2>/dev/null)
          fi

          if [ -z "$CHANGES" ]; then
            CHANGES="- Initial release"
          fi

          # Write to file to preserve newlines
          cat > /tmp/release-notes.md << NOTES
          ## ğŸ“² NFC Master Pro ${{ steps.version.outputs.TAG }}

          ### ğŸ“¥ Installation
          1. Download \`NFCMasterPro-${{ steps.version.outputs.TAG }}.apk\`
          2. On your Android device: **Settings â†’ Security â†’ Install unknown apps** â†’ Enable
          3. Open the APK file and install
          4. Grant NFC permissions when prompted

          ### âœ¨ Features
          - ğŸ“– Read NDEF / Raw Hex data from NFC tags
          - âœï¸ Write URL, Text, vCard, Smart Poster to NFC tags
          - ğŸ” Clone NFC cards (NDEF)
          - ğŸ“œ Scan history with filter & export
          - ğŸ” Hex viewer with ASCII & sector map
          - ğŸ¢ Thaiprompt member registration via NFC

          ### âš™ï¸ Requirements
          - Android 7.0+ (API level 24)
          - NFC-capable device
          - NFC enabled in settings

          ### ğŸ”„ Changes in this release
          $CHANGES

          ---
          > âš ï¸ This APK is signed with a test keystore. For production distribution, configure \`KEYSTORE_BASE64\`, \`KEY_ALIAS\`, \`KEYSTORE_PASSWORD\`, \`KEY_PASSWORD\` in GitHub Secrets.
          NOTES

          echo "âœ… Release notes generated"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 12. Publish GitHub Release
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: "NFC Master Pro ${{ steps.version.outputs.TAG }}"
          body_path: /tmp/release-notes.md
          files: /tmp/release-output/NFCMasterPro-${{ steps.version.outputs.TAG }}.apk
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”— Release URL
        run: |
          echo "ğŸ‰ Release published!"
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG }}"
